import CalendarEvent from '../../models/calendarEvent.model.js';
import SavedItem from '../../models/savedItem.model.js';
import Scholarship from '../../models/scholarship.model.js';

export const calendarController = {
    // Get all calendar events for the user (including saved scholarship deadlines and global events)
    getCalendarEvents: async (req, res) => {
        try {
            const userId = req.user.userId;

            // 1. Fetch user-created events/reminders AND global events
            const customEvents = await CalendarEvent.find({
                $or: [
                    { userId: userId },
                    { isGlobal: true }
                ]
            })
                .populate('scholarshipId', 'title country deadline')
                .lean(); // Use lean for performance and easier modification if needed

            // 2. Fetch saved scholarships to automatically show their deadlines
            // We look for SavedItems of type 'scholarship'
            const savedScholarships = await SavedItem.find({
                userId,
                itemType: 'scholarship'
            }).populate({
                path: 'itemId',
                select: 'title country deadline status university', // Include necessary fields from Scholarship
                model: 'Scholarship' // Explicitly state model if needed, though refPath usually handles it
            });

            // Transform saved scholarships into a consistent event format if they have a deadline
            const scholarshipEvents = savedScholarships
                .filter(item => item.itemId && item.itemId.deadline)
                .map(item => ({
                    _id: `auto-${item.itemId._id}`, // Virtual ID to distinguish
                    type: 'deadline', // Distinct type for auto-generated deadline events
                    title: `${item.itemId.title} Deadline`,
                    date: item.itemId.deadline,
                    scholarshipId: item.itemId, // Pass the full populated object or just ID
                    isAutoGenerated: true
                }));

            // Combine both lists
            const allEvents = [
                ...customEvents, // Already objects because of .lean()
                ...scholarshipEvents
            ];

            // Sort combined list by date
            allEvents.sort((a, b) => new Date(a.date) - new Date(b.date));

            res.status(200).json({
                success: true,
                data: allEvents
            });
        } catch (error) {
            console.error('Error fetching calendar events:', error);
            res.status(500).json({
                success: false,
                message: 'Failed to fetch calendar events',
                error: error.message
            });
        }
    },

    // Create a custom reminder or event
    createEvent: async (req, res) => {
        try {
            const userId = req.user.userId;
            const { title, date, type, scholarshipId, reminderPreferences, note, isGlobal } = req.body;

            // Check if user is admin if they are trying to create a global event
            if (isGlobal && req.user.role !== 'admin') {
                return res.status(403).json({
                    success: false,
                    message: 'Only admins can create global events'
                });
            }

            const newEvent = new CalendarEvent({
                userId: isGlobal ? undefined : userId,
                isGlobal: !!isGlobal,
                title,
                date,
                type: type || 'event',
                scholarshipId,
                reminderPreferences,
                note
            });

            await newEvent.save();

            res.status(201).json({
                success: true,
                message: 'Event created successfully',
                data: newEvent
            });
        } catch (error) {
            console.error('Error creating calendar event:', error);
            res.status(500).json({
                success: false,
                message: 'Failed to create event',
                error: error.message
            });
        }
    },

    // Delete a custom event
    deleteEvent: async (req, res) => {
        try {
            const { id } = req.params;
            const userId = req.user.userId;

            const event = await CalendarEvent.findOneAndDelete({ _id: id, userId });

            if (!event) {
                return res.status(404).json({
                    success: false,
                    message: 'Event not found or unauthorized'
                });
            }

            res.status(200).json({
                success: true,
                message: 'Event deleted successfully'
            });
        } catch (error) {
            console.error('Error deleting calendar event:', error);
            res.status(500).json({
                success: false,
                message: 'Failed to delete event',
                error: error.message
            });
        }
    }
};
